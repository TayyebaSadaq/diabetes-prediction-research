import pandas as pd
import scipy
import numpy as np
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import train_test_split
import seaborn as sns
import matplotlib.pyplot as plt
import pickle
import csv

# ~ Loading Data ``
data_path = "data\\raw_data.csv"
data = pd.read_excel(data_path)
print("data read")

# ~ Inspecting data
print(data.head())
data.info()
print(data.isnull().sum())

print(data.describe())

# ~ Feature Scaling
""" need to standardise data with wide numeric ranges to better suit 
ML algorithms """
scaler = StandardScaler()
# ~ Only applied to features that have a large range (~30) 
""" some have smaller scales so i've left them out for now
Might revisit later to see if scaling those helps model performance"""
scaled_features = scaler.fit_transform(data[['BMI','MentHlth','PhysHlth']])

# ~ Split the data into test and train sets for diabetes prediction
X = data[['HighBP', 'HighChol', 'CholCheck', 'BMI', 'Smoker', 'Stroke', 'HeartDiseaseorAttack', 'PhysActivity', 'Fruits', 'Veggies', 'HvyAlcoholConsump', 'AnyHealthcare', 'NoDocbcCost', 'GenHlth', 'MentHlth', 'PhysHlth', 'DiffWalk', 'Sex', 'Age', 'Education', 'Income']]
""" 0 is for no diabetes while 1is for either pre-diabetes or diabetes - can later use more datasets to improve classification? """
y = data['Diabetes_binary']
""" splitting the data with stratification to keep class distribution, doing a 80-20 split """
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

# ~ Saving the preprocessed data - later load for model training/evaluation etc
with open("data\\preprocessed_data.pkl", "wb") as f:
    pickle.dump((X_train, X_test, y_train, y_test, scaler), f)
print("Preprocessed data saved as .pkl.")

# ~ Saving the preprocessed data as CSV for visualisations
data_scaled = data.copy()
data_scaled[['BMI','MentHlth','PhysHlth']] = scaled_features
""" combine x and y into 1 dataframe """
processed_df = pd.concat([data_scaled[X.columns], y], axis=1)
processed_df.to_csv("data\\preprocessed_data.csv", index=False)
print("Preprocessed data saved as CSV.")